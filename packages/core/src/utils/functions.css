/**
 * Shift CSS - CSS Functions & Logic Utilities
 *
 * Native CSS functions using @function and if() for dynamic styling.
 * No preprocessor required - pure CSS logic engine.
 *
 * Usage:
 *   .card { box-shadow: --s-glow(var(--s-primary-500), 2); }
 *   .text { color: --s-alpha(var(--s-primary-500), 0.5); }
 *
 * Browser Support:
 *   - Chrome 139+, Edge 139+: Full support
 *   - Firefox/Safari: Fallback to static values
 */

/* =============================================================================
   COLOR MANIPULATION FUNCTIONS
   ============================================================================= */

/**
 * --s-alpha: Add transparency to any color
 * @param --color: The base color
 * @param --opacity: Opacity value (0-1)
 */
@function --s-alpha(--color, --opacity) {
  result: oklch(from var(--color) l c h / var(--opacity));
}

/**
 * --s-lighten: Increase lightness of a color
 * @param --color: The base color
 * @param --amount: Amount to lighten (0-1, e.g., 0.1 = 10%)
 */
@function --s-lighten(--color, --amount) {
  result: oklch(from var(--color) calc(l + var(--amount)) c h);
}

/**
 * --s-darken: Decrease lightness of a color
 * @param --color: The base color
 * @param --amount: Amount to darken (0-1, e.g., 0.1 = 10%)
 */
@function --s-darken(--color, --amount) {
  result: oklch(from var(--color) calc(l - var(--amount)) c h);
}

/**
 * --s-saturate: Increase chroma/saturation (gamut-aware)
 * Boosts the C (Chroma) channel while clamping to prevent gamut overflow.
 * Colors are pushed toward P3 space limits when hardware supports it.
 * @param --color: The base color
 * @param --amount: Amount to increase (0-0.4)
 */
@function --s-saturate(--color, --amount) {
  result: oklch(from var(--color) l min(0.4, calc(c + var(--amount))) h);
}

/**
 * --s-desaturate: Decrease chroma/saturation
 * Pulls the C (Chroma) channel toward zero, creating muted/grayscale versions
 * while retaining the same perceived brightness. Clamped to prevent negatives.
 * @param --color: The base color
 * @param --amount: Amount to decrease (0-0.4)
 */
@function --s-desaturate(--color, --amount) {
  result: oklch(from var(--color) l max(0, calc(c - var(--amount))) h);
}

/**
 * --s-hue-rotate: Shift the hue of a color
 * @param --color: The base color
 * @param --degrees: Degrees to rotate (0-360)
 */
@function --s-hue-rotate(--color, --degrees) {
  result: oklch(from var(--color) l c calc(h + var(--degrees)));
}

/**
 * --s-complement: Get the complementary color (180° hue shift)
 * @param --color: The base color
 */
@function --s-complement(--color) {
  result: oklch(from var(--color) l c calc(h + 180));
}

/* =============================================================================
   EFFECT FUNCTIONS
   ============================================================================= */

/**
 * --s-glow: Generate a glowing box-shadow simulating light emission
 * Uses boosted chroma in inner layers for vibrant "light source" effect,
 * fading to softer outer layers. The high-chroma core simulates photon emission.
 * @param --color: The glow color
 * @param --intensity: Intensity multiplier (1-5)
 */
@function --s-glow(--color, --intensity) {
  result: 0 0 calc(var(--intensity) * 10px) oklch(from var(--color) l min(0.4, calc(c * 1.3)) h / 0.6),
          0 0 calc(var(--intensity) * 20px) oklch(from var(--color) l min(0.35, calc(c * 1.15)) h / 0.35),
          0 0 calc(var(--intensity) * 30px) oklch(from var(--color) l c h / 0.15);
}

/**
 * --s-text-shadow-glow: Generate a text glow effect for enhanced legibility
 * Three-layer system: crisp edge (1px) preserves letter shapes, mid-layer provides
 * the visible glow, outer layer adds atmospheric diffusion. Optimized for
 * dark backgrounds without blurring text readability.
 * @param --color: The glow color
 * @param --intensity: Intensity multiplier (1-3)
 */
@function --s-text-shadow-glow(--color, --intensity) {
  result: 0 0 1px oklch(from var(--color) l c h / 0.9),
          0 0 calc(var(--intensity) * 4px) oklch(from var(--color) l c h / 0.7),
          0 0 calc(var(--intensity) * 12px) oklch(from var(--color) l c h / 0.35);
}

/* =============================================================================
   CONTRAST & ACCESSIBILITY FUNCTIONS
   ============================================================================= */

/**
 * --s-contrast-text: Auto-pick accessible text color using WCAG 2.2 contrast
 * Uses native color-contrast() to let the browser calculate true luminance
 * and select the highest-contrast option between white and black.
 * @param --bg: The background color
 */
@function --s-contrast-text(--bg) {
  result: color-contrast(var(--bg) vs oklch(0.98 0 0), oklch(0.15 0 0));
}

/**
 * Legacy fallback for browsers without color-contrast() support
 * Uses 0.6 OKLCH lightness threshold as pragmatic approximation
 */
@function --s-contrast-text-fallback(--bg) {
  result: oklch(from var(--bg) clamp(0.15, calc((0.6 - l) * 1000 + 0.15), 0.95) 0 0);
}

/**
 * --s-readable-on: Return accessible version of a brand color on any background
 * Preserves the text color's hue and chroma while aggressively adjusting lightness
 * to ensure readability. Dark backgrounds push text lighter, light backgrounds push
 * text darker. The 50/50 mix ensures strong contrast while retaining brand identity.
 * @param --bg: The background color
 * @param --text: The desired text color (brand hue to preserve)
 */
@function --s-readable-on(--bg, --text) {
  result: color-mix(
    in oklch,
    var(--text) 50%,
    oklch(from var(--bg) clamp(0.15, calc(1.1 - l), 0.95) 0 0)
  );
}

/* =============================================================================
   SPACING & SIZING FUNCTIONS
   ============================================================================= */

/**
 * --s-fluid: Generate fluid sizing with clamp
 * @param --min: Minimum size
 * @param --max: Maximum size
 */
@function --s-fluid(--min, --max) {
  result: clamp(
    var(--min),
    calc(var(--min) + (var(--max) - var(--min)) * ((100vw - 320px) / (1200px - 320px))),
    var(--max)
  );
}

/**
 * --s-space-scale: Generate rhythm-aligned spacing with quantized snapping
 * Calculates base × factor, then snaps the result to the nearest multiple
 * of the base unit. This "quantize" approach prevents sub-pixel jitter and
 * ensures all spacing aligns to the global grid (e.g., 4px rhythm → 4, 8, 12, 16px).
 * @param --base: Base spacing unit (e.g., 4px for a 4px grid)
 * @param --factor: Multiplication factor (any number, output will snap)
 */
@function --s-space-scale(--base, --factor) {
  result: round(nearest, calc(var(--base) * var(--factor)), var(--base));
}

/* =============================================================================
   CONDITIONAL STYLING WITH if()
   Self-healing components that adapt to their context
   ============================================================================= */

/**
 * Auto-contrast card example:
 * Cards automatically adjust text color based on their background
 */
[s-card][s-auto-contrast] {
  /* Fallback for non-supporting browsers */
  color: var(--s-text-primary);

  /* Self-healing: flip text color if background is too dark/light */
  color: if(
    supports(color: oklch(from red l c h)):
      --s-contrast-text(var(--_card-bg));
    else: var(--s-text-primary);
  );
}

/**
 * Responsive padding using if() instead of media queries
 */
[s-responsive-padding] {
  /* Fallback for non-supporting browsers */
  padding: var(--s-space-4);

  padding: if(
    media(width < 640px): var(--s-space-2);
    media(width < 1024px): var(--s-space-4);
    else: var(--s-space-6);
  );
}

/**
 * Motion-safe animations using if()
 */
[s-motion-safe] {
  /* Fallback for non-supporting browsers */
  transition-duration: var(--s-duration-200);

  transition-duration: if(
    media(prefers-reduced-motion: reduce): 0ms;
    else: var(--s-duration-200);
  );
}

/**
 * Dark Mode Aware Styling
 *
 * A sophisticated dark-awareness system that goes beyond simple color swaps:
 *
 * 1. CONTAINER-RELATIVE THEMING
 *    Uses CSS style queries to detect parent theme context, not just system preference.
 *    A dark sidebar on a light-mode site will correctly theme its children.
 *
 * 2. PERCEPTUAL OKLCH CONTRAST
 *    Uses OKLCH lightness math to ensure text readability on any background.
 *    No manual light/dark text color definitions needed.
 *
 * 3. VISUAL ADAPTATION BEYOND COLOR
 *    - Border glow: Subtle inner highlight prevents dark elements from "bleeding"
 *    - Font weight: Reduces weight ~50 units to counter halation (light-on-dark bloat)
 *
 * Usage:
 *   <div s-theme="dark">                    <!-- Explicit dark container -->
 *     <div s-dark-aware>Auto-adapts!</div>  <!-- Inherits dark context -->
 *   </div>
 *
 *   <div s-dark-aware>                      <!-- Falls back to system preference -->
 *     Content here
 *   </div>
 */

/* =============================================================================
   THEME CONTAINER SETUP
   Containers that establish a theme context for descendants
   ============================================================================= */

/**
 * Theme containers - establish dark/light context for style queries
 * These create a "theme boundary" that s-dark-aware elements can detect
 */
[s-theme] {
  container-name: theme;
}

[s-theme="dark"] {
  --_theme-is-dark: 1;
  color-scheme: dark;
  background-color: var(--s-surface-sunken, oklch(12% 0.02 220));
  color: var(--s-text-primary, oklch(95% 0.01 220));
}

[s-theme="light"] {
  --_theme-is-dark: 0;
  color-scheme: light;
  background-color: var(--s-surface-raised, oklch(98% 0.005 220));
  color: var(--s-text-primary, oklch(15% 0.02 220));
}

/* =============================================================================
   DARK-AWARE COMPONENT
   Self-healing elements that adapt to their theme context
   ============================================================================= */

[s-dark-aware] {
  /**
   * LAYER 1: System preference baseline (universal fallback)
   * Works in all browsers, detects OS-level dark mode
   */
  --_da-is-dark: 0;
  --_da-bg: var(--s-surface-raised);

  @media (prefers-color-scheme: dark) {
    --_da-is-dark: 1;
    --_da-bg: var(--s-surface-sunken);
  }

  /**
   * LAYER 2: Container-relative theming via style queries
   * If inside an [s-theme] container, inherit its theme regardless of system preference
   * This enables "dark islands" on light sites and vice versa
   */
  @supports (container-type: inline-size) {
    @container theme style(--_theme-is-dark: 1) {
      --_da-is-dark: 1;
      --_da-bg: var(--s-surface-sunken);
    }

    @container theme style(--_theme-is-dark: 0) {
      --_da-is-dark: 0;
      --_da-bg: var(--s-surface-raised);
    }
  }

  /* Apply computed background */
  background-color: var(--_da-bg);

  /**
   * LAYER 3: OKLCH Perceptual Contrast Text
   * Automatically compute readable text color based on background lightness
   * Uses L=0.55 threshold for WCAG 2.1 AA 4.5:1 contrast
   */
  color: var(--s-text-primary); /* Fallback */

  @supports (color: oklch(from red l c h)) {
    color: oklch(
      from var(--_da-bg)
      /* If background L < 0.55: use light text (L=0.95), else dark text (L=0.15) */
      clamp(0.15, calc((0.55 - l) * 1000 + 0.15), 0.95)
      0 0
    );
  }

  /**
   * LAYER 4: Border Glow (Dark Mode Anti-Bleed)
   * In dark mode, elements can "bleed" into dark backgrounds.
   * A subtle inner highlight (0.5px at 8% white) creates visual separation.
   * Only applies when --_da-is-dark is 1.
   */
  --_da-glow-opacity: calc(var(--_da-is-dark) * 0.08);
  box-shadow: inset 0 0 0 0.5px oklch(1 0 0 / var(--_da-glow-opacity));

  /**
   * LAYER 5: Font Weight Compensation (Halation Correction)
   * Light text on dark backgrounds appears "fatter" due to light bleed (halation).
   * We reduce font-weight by 50 units in dark mode to maintain visual consistency.
   * Uses @property for type-safe font-weight interpolation.
   */
  --_da-weight-base: var(--s-font-weight-normal, 400);
  --_da-weight-adjustment: calc(var(--_da-is-dark) * 50);
  font-weight: calc(var(--_da-weight-base) - var(--_da-weight-adjustment));
}

/**
 * Variant: s-dark-aware="subtle"
 * Less aggressive adaptations for inline/text elements
 */
[s-dark-aware="subtle"] {
  /* No background change, just text and weight */
  background-color: transparent;
  box-shadow: none;
}

/**
 * Variant: s-dark-aware="strong"
 * More pronounced dark mode effects for hero sections
 */
[s-dark-aware="strong"] {
  --_da-glow-opacity: calc(var(--_da-is-dark) * 0.12);
  box-shadow:
    inset 0 0 0 0.5px oklch(1 0 0 / var(--_da-glow-opacity)),
    inset 0 1px 0 0 oklch(1 0 0 / calc(var(--_da-is-dark) * 0.05));
}

/* =============================================================================
   SIZE-BASED CONDITIONAL STYLING
   Components that adapt based on custom property state
   ============================================================================= */

/**
 * Size variants using style queries with if()
 */
[s-size-aware] {
  /* Fallback for non-supporting browsers */
  padding: var(--s-space-4);
  font-size: var(--s-text-base);

  padding: if(
    style(--size: sm): var(--s-space-2);
    style(--size: lg): var(--s-space-6);
    else: var(--s-space-4);
  );

  font-size: if(
    style(--size: sm): var(--s-text-sm);
    style(--size: lg): var(--s-text-lg);
    else: var(--s-text-base);
  );
}

/* =============================================================================
   ACCESSIBILITY
   ============================================================================= */

@media (prefers-reduced-motion: reduce) {
  [s-motion-safe] {
    transition-duration: 0ms !important;
  }
}
