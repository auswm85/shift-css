/**
 * Shift CSS - CSS Functions & Logic Utilities
 *
 * Native CSS functions using @function and if() for dynamic styling.
 * No preprocessor required - pure CSS logic engine.
 *
 * Usage:
 *   .card { box-shadow: --s-glow(var(--s-primary-500), 2); }
 *   .text { color: --s-alpha(var(--s-primary-500), 0.5); }
 *
 * Browser Support:
 *   - Chrome 139+, Edge 139+: Full support
 *   - Firefox/Safari: Fallback to static values
 */

/* =============================================================================
   COLOR MANIPULATION FUNCTIONS
   ============================================================================= */

/**
 * --s-alpha: Add transparency to any color
 * @param --color: The base color
 * @param --opacity: Opacity value (0-1)
 */
@function --s-alpha(--color, --opacity) {
  result: oklch(from var(--color) l c h / var(--opacity));
}

/**
 * --s-lighten: Increase lightness of a color
 * @param --color: The base color
 * @param --amount: Amount to lighten (0-1, e.g., 0.1 = 10%)
 */
@function --s-lighten(--color, --amount) {
  result: oklch(from var(--color) calc(l + var(--amount)) c h);
}

/**
 * --s-darken: Decrease lightness of a color
 * @param --color: The base color
 * @param --amount: Amount to darken (0-1, e.g., 0.1 = 10%)
 */
@function --s-darken(--color, --amount) {
  result: oklch(from var(--color) calc(l - var(--amount)) c h);
}

/**
 * --s-saturate: Increase chroma/saturation
 * @param --color: The base color
 * @param --amount: Amount to increase (0-0.4)
 */
@function --s-saturate(--color, --amount) {
  result: oklch(from var(--color) l calc(c + var(--amount)) h);
}

/**
 * --s-desaturate: Decrease chroma/saturation
 * @param --color: The base color
 * @param --amount: Amount to decrease (0-0.4)
 */
@function --s-desaturate(--color, --amount) {
  result: oklch(from var(--color) l calc(c - var(--amount)) h);
}

/**
 * --s-hue-rotate: Shift the hue of a color
 * @param --color: The base color
 * @param --degrees: Degrees to rotate (0-360)
 */
@function --s-hue-rotate(--color, --degrees) {
  result: oklch(from var(--color) l c calc(h + var(--degrees)));
}

/**
 * --s-complement: Get the complementary color (180° hue shift)
 * @param --color: The base color
 */
@function --s-complement(--color) {
  result: oklch(from var(--color) l c calc(h + 180));
}

/* =============================================================================
   EFFECT FUNCTIONS
   ============================================================================= */

/**
 * --s-glow: Generate a glowing box-shadow
 * @param --color: The glow color
 * @param --intensity: Intensity multiplier (1-5)
 */
@function --s-glow(--color, --intensity) {
  result: 0 0 calc(var(--intensity) * 10px) oklch(from var(--color) l c h / 0.5),
          0 0 calc(var(--intensity) * 20px) oklch(from var(--color) l c h / 0.3),
          0 0 calc(var(--intensity) * 30px) oklch(from var(--color) l c h / 0.1);
}

/**
 * --s-text-shadow-glow: Generate a text glow effect
 * @param --color: The glow color
 * @param --intensity: Intensity multiplier (1-3)
 */
@function --s-text-shadow-glow(--color, --intensity) {
  result: 0 0 calc(var(--intensity) * 5px) oklch(from var(--color) l c h / 0.8),
          0 0 calc(var(--intensity) * 10px) oklch(from var(--color) l c h / 0.5);
}

/* =============================================================================
   CONTRAST & ACCESSIBILITY FUNCTIONS
   ============================================================================= */

/**
 * --s-contrast-text: Return black or white based on background lightness
 * Uses 0.6 OKLCH lightness threshold (pragmatic heuristic, not WCAG luminance)
 * @param --bg: The background color
 */
@function --s-contrast-text(--bg) {
  result: oklch(from var(--bg) clamp(0.15, calc((0.6 - l) * 1000 + 0.15), 0.95) 0 0);
}

/**
 * --s-readable-on: Ensure text is readable on a given background
 * Shifts text lightness based on background: dark bg → lighter text, light bg → darker text
 * @param --bg: The background color
 * @param --text: The desired text color
 */
@function --s-readable-on(--bg, --text) {
  /* Mix text with inverted bg lightness (achromatic) to push toward contrast */
  /* Dark bg (l≈0) → mix with light (1-l≈1), Light bg (l≈1) → mix with dark (1-l≈0) */
  result: color-mix(
    in oklch,
    var(--text) 60%,
    oklch(from var(--bg) clamp(0.2, calc(1 - l), 0.9) 0 0)
  );
}

/* =============================================================================
   SPACING & SIZING FUNCTIONS
   ============================================================================= */

/**
 * --s-fluid: Generate fluid sizing with clamp
 * @param --min: Minimum size
 * @param --max: Maximum size
 */
@function --s-fluid(--min, --max) {
  result: clamp(
    var(--min),
    calc(var(--min) + (var(--max) - var(--min)) * ((100vw - 320px) / (1200px - 320px))),
    var(--max)
  );
}

/**
 * --s-space-scale: Multiply a spacing value
 * @param --base: Base spacing value
 * @param --factor: Multiplication factor
 */
@function --s-space-scale(--base, --factor) {
  result: calc(var(--base) * var(--factor));
}

/* =============================================================================
   CONDITIONAL STYLING WITH if()
   Self-healing components that adapt to their context
   ============================================================================= */

/**
 * Auto-contrast card example:
 * Cards automatically adjust text color based on their background
 */
[s-card][s-auto-contrast] {
  /* Fallback for non-supporting browsers */
  color: var(--s-text-primary);

  /* Self-healing: flip text color if background is too dark/light */
  color: if(
    supports(color: oklch(from red l c h)):
      --s-contrast-text(var(--_card-bg));
    else: var(--s-text-primary);
  );
}

/**
 * Responsive padding using if() instead of media queries
 */
[s-responsive-padding] {
  /* Fallback for non-supporting browsers */
  padding: var(--s-space-4);

  padding: if(
    media(width < 640px): var(--s-space-2);
    media(width < 1024px): var(--s-space-4);
    else: var(--s-space-6);
  );
}

/**
 * Motion-safe animations using if()
 */
[s-motion-safe] {
  /* Fallback for non-supporting browsers */
  transition-duration: var(--s-duration-200);

  transition-duration: if(
    media(prefers-reduced-motion: reduce): 0ms;
    else: var(--s-duration-200);
  );
}

/**
 * Dark Mode Aware Styling
 *
 * A sophisticated dark-awareness system that goes beyond simple color swaps:
 *
 * 1. CONTAINER-RELATIVE THEMING
 *    Uses CSS style queries to detect parent theme context, not just system preference.
 *    A dark sidebar on a light-mode site will correctly theme its children.
 *
 * 2. PERCEPTUAL OKLCH CONTRAST
 *    Uses OKLCH lightness math to ensure text readability on any background.
 *    No manual light/dark text color definitions needed.
 *
 * 3. VISUAL ADAPTATION BEYOND COLOR
 *    - Border glow: Subtle inner highlight prevents dark elements from "bleeding"
 *    - Font weight: Reduces weight ~50 units to counter halation (light-on-dark bloat)
 *
 * Usage:
 *   <div s-theme="dark">                    <!-- Explicit dark container -->
 *     <div s-dark-aware>Auto-adapts!</div>  <!-- Inherits dark context -->
 *   </div>
 *
 *   <div s-dark-aware>                      <!-- Falls back to system preference -->
 *     Content here
 *   </div>
 */

/* =============================================================================
   THEME CONTAINER SETUP
   Containers that establish a theme context for descendants
   ============================================================================= */

/**
 * Theme containers - establish dark/light context for style queries
 * These create a "theme boundary" that s-dark-aware elements can detect
 */
[s-theme] {
  container-name: theme;
}

[s-theme="dark"] {
  --_theme-is-dark: 1;
  color-scheme: dark;
  background-color: var(--s-surface-sunken, oklch(12% 0.02 220));
  color: var(--s-text-primary, oklch(95% 0.01 220));
}

[s-theme="light"] {
  --_theme-is-dark: 0;
  color-scheme: light;
  background-color: var(--s-surface-raised, oklch(98% 0.005 220));
  color: var(--s-text-primary, oklch(15% 0.02 220));
}

/* =============================================================================
   DARK-AWARE COMPONENT
   Self-healing elements that adapt to their theme context
   ============================================================================= */

[s-dark-aware] {
  /**
   * LAYER 1: System preference baseline (universal fallback)
   * Works in all browsers, detects OS-level dark mode
   */
  --_da-is-dark: 0;
  --_da-bg: var(--s-surface-raised);

  @media (prefers-color-scheme: dark) {
    --_da-is-dark: 1;
    --_da-bg: var(--s-surface-sunken);
  }

  /**
   * LAYER 2: Container-relative theming via style queries
   * If inside an [s-theme] container, inherit its theme regardless of system preference
   * This enables "dark islands" on light sites and vice versa
   */
  @supports (container-type: inline-size) {
    @container theme style(--_theme-is-dark: 1) {
      --_da-is-dark: 1;
      --_da-bg: var(--s-surface-sunken);
    }

    @container theme style(--_theme-is-dark: 0) {
      --_da-is-dark: 0;
      --_da-bg: var(--s-surface-raised);
    }
  }

  /* Apply computed background */
  background-color: var(--_da-bg);

  /**
   * LAYER 3: OKLCH Perceptual Contrast Text
   * Automatically compute readable text color based on background lightness
   * Uses L=0.55 threshold for WCAG 2.1 AA 4.5:1 contrast
   */
  color: var(--s-text-primary); /* Fallback */

  @supports (color: oklch(from red l c h)) {
    color: oklch(
      from var(--_da-bg)
      /* If background L < 0.55: use light text (L=0.95), else dark text (L=0.15) */
      clamp(0.15, calc((0.55 - l) * 1000 + 0.15), 0.95)
      0 0
    );
  }

  /**
   * LAYER 4: Border Glow (Dark Mode Anti-Bleed)
   * In dark mode, elements can "bleed" into dark backgrounds.
   * A subtle inner highlight (0.5px at 8% white) creates visual separation.
   * Only applies when --_da-is-dark is 1.
   */
  --_da-glow-opacity: calc(var(--_da-is-dark) * 0.08);
  box-shadow: inset 0 0 0 0.5px oklch(1 0 0 / var(--_da-glow-opacity));

  /**
   * LAYER 5: Font Weight Compensation (Halation Correction)
   * Light text on dark backgrounds appears "fatter" due to light bleed (halation).
   * We reduce font-weight by 50 units in dark mode to maintain visual consistency.
   * Uses @property for type-safe font-weight interpolation.
   */
  --_da-weight-base: var(--s-font-weight-normal, 400);
  --_da-weight-adjustment: calc(var(--_da-is-dark) * 50);
  font-weight: calc(var(--_da-weight-base) - var(--_da-weight-adjustment));
}

/**
 * Variant: s-dark-aware="subtle"
 * Less aggressive adaptations for inline/text elements
 */
[s-dark-aware="subtle"] {
  /* No background change, just text and weight */
  background-color: transparent;
  box-shadow: none;
}

/**
 * Variant: s-dark-aware="strong"
 * More pronounced dark mode effects for hero sections
 */
[s-dark-aware="strong"] {
  --_da-glow-opacity: calc(var(--_da-is-dark) * 0.12);
  box-shadow:
    inset 0 0 0 0.5px oklch(1 0 0 / var(--_da-glow-opacity)),
    inset 0 1px 0 0 oklch(1 0 0 / calc(var(--_da-is-dark) * 0.05));
}

/* =============================================================================
   SIZE-BASED CONDITIONAL STYLING
   Components that adapt based on custom property state
   ============================================================================= */

/**
 * Size variants using style queries with if()
 */
[s-size-aware] {
  /* Fallback for non-supporting browsers */
  padding: var(--s-space-4);
  font-size: var(--s-text-base);

  padding: if(
    style(--size: sm): var(--s-space-2);
    style(--size: lg): var(--s-space-6);
    else: var(--s-space-4);
  );

  font-size: if(
    style(--size: sm): var(--s-text-sm);
    style(--size: lg): var(--s-text-lg);
    else: var(--s-text-base);
  );
}

/* =============================================================================
   ACCESSIBILITY
   ============================================================================= */

@media (prefers-reduced-motion: reduce) {
  [s-motion-safe] {
    transition-duration: 0ms !important;
  }
}
