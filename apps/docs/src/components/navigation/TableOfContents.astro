---
import { filterTocHeadings, type TocHeading } from '../../utils/toc';

interface Props {
	headings: TocHeading[];
}

const { headings } = Astro.props;
const tocHeadings = filterTocHeadings(headings);
---

{
	tocHeadings.length > 0 && (
		<nav aria-label="Table of contents">
			<span class="docs-toc-label">On this page</span>
			<ul class="docs-toc-list">
				{tocHeadings.map((heading) => (
					<li>
						<a
							href={`#${heading.slug}`}
							class="docs-toc-link"
							data-level={heading.depth}
							data-toc-link
						>
							{heading.text}
						</a>
					</li>
				))}
			</ul>
		</nav>
	)
}

<script>
	function initTocHighlight() {
		const tocLinks = document.querySelectorAll('[data-toc-link]');
		if (tocLinks.length === 0) return;

		function updateFromHash() {
			const hash = window.location.hash || '';
			tocLinks.forEach((link, index) => {
				const href = link.getAttribute('href');
				// Match hash, or default to first link if no hash
				const isActive = hash ? href === hash : index === 0;
				link.setAttribute('aria-current', isActive ? 'true' : 'false');
			});
		}

		// Update on click (immediately, before hash changes)
		tocLinks.forEach((link, index) => {
			link.addEventListener('click', (e) => {
				tocLinks.forEach((l) => l.setAttribute('aria-current', 'false'));
				link.setAttribute('aria-current', 'true');

				// First link scrolls to top of page
				if (index === 0) {
					e.preventDefault();
					window.scrollTo({ top: 0, behavior: 'smooth' });
					history.pushState(null, '', link.getAttribute('href') || '');
				}
			});
		});

		// Initial state and hash changes
		updateFromHash();
		window.addEventListener('hashchange', updateFromHash);

		// Cleanup on page transitions
		document.addEventListener(
			'astro:before-swap',
			() => {
				window.removeEventListener('hashchange', updateFromHash);
			},
			{ once: true }
		);
	}

	// Initialize on load
	initTocHighlight();

	// Re-init after Astro page transitions
	document.addEventListener('astro:after-swap', initTocHighlight);
</script>
