---
import { Code } from 'astro:components';

interface Props {
	/** The HTML code to display (used for code block) */
	code: string;
	/** Optional title for the demo */
	title?: string;
	/** Whether to show the code block (default: true) */
	showCode?: boolean;
	/** Language for syntax highlighting (default: html) */
	lang?: 'html' | 'css' | 'js';
	/**
	 * Force a specific theme for this demo ("dark" | "light" | "split")
	 * - "dark": Demo preview uses dark theme context
	 * - "light": Demo preview uses light theme context
	 * - "split": Shows both light and dark side-by-side
	 * - undefined: Follows system/page theme
	 */
	theme?: 'dark' | 'light' | 'split';
}

const { code, title, showCode = true, lang = 'html', theme } = Astro.props;

// Clean up the code for display (trim whitespace)
const cleanCode = code.trim();

// Determine container classes
const previewClass = theme === 'split' ? 'demo-preview demo-preview--split' : 'demo-preview';
---

<div class="demo-container">
	{title && <p class="demo-title">{title}</p>}
	{theme === 'split' ? (
		<div class={previewClass}>
			<div class="demo-preview-pane" s-theme="light">
				<div class="demo-pane-header">Light</div>
				<div class="demo-pane-content">
					<Fragment set:html={cleanCode} />
				</div>
			</div>
			<div class="demo-preview-pane" s-theme="dark">
				<div class="demo-pane-header">Dark</div>
				<div class="demo-pane-content">
					<Fragment set:html={cleanCode} />
				</div>
			</div>
		</div>
	) : theme ? (
		<div class={previewClass} s-theme={theme}>
			<Fragment set:html={cleanCode} />
		</div>
	) : (
		<div class={previewClass}>
			<Fragment set:html={cleanCode} />
		</div>
	)}
	{showCode && (
		<div class="demo-code">
			<Code code={cleanCode} lang={lang} theme="css-variables" />
		</div>
	)}
</div>

<style>
	.demo-container {
		margin: var(--s-space-6) 0;
		border: 1px solid var(--s-border-default);
		border-radius: var(--s-radius-lg);
	}

	.demo-title {
		padding: var(--s-space-3) var(--s-space-4);
		margin: 0;
		font-size: var(--s-text-sm);
		font-weight: var(--s-font-medium);
		color: var(--s-text-secondary);
		background: var(--s-surface-sunken);
		border-bottom: 1px solid var(--s-border-default);
	}

	.demo-preview {
		padding: var(--s-space-6);
		background: var(--s-surface-default);
	}

	/* Theme island support - forced dark/light contexts */
	.demo-preview[s-theme='dark'] {
		background: oklch(12% 0.025 220);
		color: oklch(95% 0.01 220);
	}

	.demo-preview[s-theme='light'] {
		background: oklch(98% 0.005 220);
		color: oklch(8% 0.02 220);
	}

	/* Split view - side-by-side light and dark */
	.demo-preview--split {
		display: grid;
		grid-template-columns: 1fr 1fr;
		padding: 0;
		gap: 1px;
		background: var(--s-border-default);
	}

	.demo-preview-pane {
		display: flex;
		flex-direction: column;
	}

	.demo-preview-pane[s-theme='light'] {
		background: oklch(98% 0.005 220);
		color: oklch(8% 0.02 220);
	}

	.demo-preview-pane[s-theme='dark'] {
		background: oklch(12% 0.025 220);
		color: oklch(95% 0.01 220);
	}

	.demo-pane-header {
		padding: 0.375rem 0.75rem;
		font-size: 10px;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	/* Ensure accessible contrast for labels */
	.demo-preview-pane[s-theme='light'] .demo-pane-header {
		color: oklch(45% 0.02 220);
		border-bottom: 1px solid oklch(85% 0.01 220);
	}

	.demo-preview-pane[s-theme='dark'] .demo-pane-header {
		color: oklch(75% 0.02 220);
		border-bottom: 1px solid oklch(25% 0.02 220);
	}

	.demo-pane-content {
		padding: var(--s-space-6);
	}

	/* Responsive: stack on mobile */
	@media (max-width: 640px) {
		.demo-preview--split {
			grid-template-columns: 1fr;
		}
	}

	.demo-code {
		border-top: 1px solid var(--s-border-default);
		background: var(--s-surface-sunken);
	}

	/* Handle border-radius for first/last children */
	.demo-container > :first-child {
		border-radius: var(--s-radius-lg) var(--s-radius-lg) 0 0;
	}

	.demo-container > :last-child {
		border-radius: 0 0 var(--s-radius-lg) var(--s-radius-lg);
	}

	.demo-container > :only-child {
		border-radius: var(--s-radius-lg);
	}

	/* Override Astro's Code component styling */
	.demo-code :global(pre) {
		margin: 0;
		padding: var(--s-space-4);
		border-radius: 0;
		font-size: var(--s-text-sm);
		overflow-x: auto;
	}

	/* Ensure demo content doesn't inherit prose styles (except dialogs which need margin: auto) */
	.demo-preview :global(*:not(dialog)) {
		margin: 0;
	}

	/* Common demo patterns */
	.demo-preview :global(.demo-row) {
		display: flex;
		flex-wrap: wrap;
		gap: var(--s-space-3);
		align-items: center;
	}

	.demo-preview :global(.demo-grid) {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: var(--s-space-4);
	}

	.demo-preview :global(.demo-stack) {
		display: flex;
		flex-direction: column;
		gap: var(--s-space-3);
	}
</style>
