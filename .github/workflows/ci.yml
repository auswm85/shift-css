name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE.md"
      - ".github/CODEOWNERS"
      - "assets/**"
  pull_request:
    branches: [main]
    paths-ignore:
      - "*.md"
      - "LICENSE"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/PULL_REQUEST_TEMPLATE.md"
      - ".github/CODEOWNERS"
      - "assets/**"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Check bundle size
        run: |
          MINIFIED_SIZE=$(stat -c%s packages/core/dist/shift.min.css 2>/dev/null || stat -f%z packages/core/dist/shift.min.css)
          MINIFIED_KB=$(echo "scale=2; $MINIFIED_SIZE / 1024" | bc)
          GZIP_SIZE=$(gzip -c packages/core/dist/shift.min.css | wc -c)
          GZIP_KB=$(echo "scale=2; $GZIP_SIZE / 1024" | bc)

          echo "üìä Bundle Size Report"
          echo "====================="
          echo "Minified: ${MINIFIED_KB} KB"
          echo "Gzipped:  ${GZIP_KB} KB"

          # Fail if gzipped size exceeds 15KB target
          MAX_SIZE=15360
          if [ "$GZIP_SIZE" -gt "$MAX_SIZE" ]; then
            echo "‚ùå Bundle exceeds 15KB gzipped target!"
            exit 1
          else
            echo "‚úÖ Bundle size within target (<15KB gzipped)"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: packages/core/dist/
          retention-days: 7

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run TypeScript check
        run: cd packages/core && bunx tsc --noEmit

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Run unit tests
        run: cd packages/core && bun test

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build test image
        run: docker build -f Dockerfile.test -t shift-css-test .

      - name: Run visual tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/packages/core/tests/e2e/snapshots:/app/packages/core/tests/e2e/snapshots \
            shift-css-test \
            bun run --cwd packages/core test:visual

      - name: Run accessibility tests
        run: |
          docker run --rm shift-css-test \
            bun run --cwd packages/core test:a11y

      - name: Run contrast tests
        run: |
          docker run --rm shift-css-test \
            bun run --cwd packages/core test:contrast

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: packages/core/playwright-report/
          retention-days: 7
