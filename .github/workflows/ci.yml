name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      cli: ${{ steps.filter.outputs.cli }}
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'packages/core/**'
            cli:
              - 'packages/cli/**'
            code:
              - 'packages/**'
              - 'bun.lockb'
              - 'package.json'
              - 'tsconfig.json'
              - 'biome.json'
            docs:
              - 'apps/docs/**'

  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint

  build:
    name: Build
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build packages
        run: bun run build

      - name: Check bundle size
        if: needs.changes.outputs.core == 'true'
        run: |
          MINIFIED_SIZE=$(stat -c%s packages/core/dist/shift.min.css 2>/dev/null || stat -f%z packages/core/dist/shift.min.css)
          MINIFIED_KB=$(echo "scale=2; $MINIFIED_SIZE / 1024" | bc)
          GZIP_SIZE=$(gzip -c packages/core/dist/shift.min.css | wc -c)
          GZIP_KB=$(echo "scale=2; $GZIP_SIZE / 1024" | bc)

          echo "üìä Bundle Size Report"
          echo "====================="
          echo "Minified: ${MINIFIED_KB} KB"
          echo "Gzipped:  ${GZIP_KB} KB"

          # Fail if gzipped size exceeds 15KB target
          MAX_SIZE=15360
          if [ "$GZIP_SIZE" -gt "$MAX_SIZE" ]; then
            echo "‚ùå Bundle exceeds 15KB gzipped target!"
            exit 1
          else
            echo "‚úÖ Bundle size within target (<15KB gzipped)"
          fi

      - name: Upload artifacts
        if: needs.changes.outputs.core == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: packages/core/dist/
          retention-days: 7

  typecheck:
    name: Typecheck
    needs: changes
    if: needs.changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck core
        if: needs.changes.outputs.core == 'true'
        run: cd packages/core && bunx tsc --noEmit

      - name: Typecheck CLI
        if: needs.changes.outputs.cli == 'true'
        run: cd packages/cli && bunx tsc --noEmit

  test:
    name: Unit Tests
    needs: changes
    if: needs.changes.outputs.core == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Run unit tests
        run: cd packages/core && bun test

  e2e:
    name: E2E Tests
    needs: changes
    if: needs.changes.outputs.core == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build test image
        run: docker build -f Dockerfile.test -t shift-css-test .

      - name: Run visual tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/packages/core/tests/e2e/snapshots:/app/packages/core/tests/e2e/snapshots \
            shift-css-test \
            bun run --cwd packages/core test:visual

      - name: Run accessibility tests
        run: |
          docker run --rm shift-css-test \
            bun run --cwd packages/core test:a11y

      - name: Run contrast tests
        run: |
          docker run --rm shift-css-test \
            bun run --cwd packages/core test:contrast

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: packages/core/playwright-report/
          retention-days: 7

  docs-a11y:
    name: Docs Accessibility
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: cd apps/docs && bunx playwright install --with-deps chromium

      - name: Build core package
        run: cd packages/core && bun run build

      - name: Build docs
        run: cd apps/docs && bun run build

      - name: Run accessibility tests
        run: cd apps/docs && bun run test:a11y

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docs-a11y-report
          path: apps/docs/playwright-report/
          retention-days: 7
